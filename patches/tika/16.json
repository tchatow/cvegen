[{"method": "org.apache.tika.parser.pkg.RarParser.parse(java.io.InputStream,org.xml.sax.ContentHandler,org.apache.tika.metadata.Metadata,org.apache.tika.parser.ParseContext)", "content": "    public void parse(InputStream stream, ContentHandler handler, Metadata metadata,\n                      ParseContext context) throws IOException, SAXException, TikaException {\n\n        XHTMLContentHandler xhtml = new XHTMLContentHandler(handler, metadata);\n        xhtml.startDocument();\n\n        EmbeddedDocumentExtractor extractor =\n                EmbeddedDocumentUtil.getEmbeddedDocumentExtractor(context);\n        String mediaType = metadata.get(Metadata.CONTENT_TYPE);\n\n        if (mediaType != null && mediaType.contains(\"version=5\")) {\n            throw new UnsupportedFormatException(\"Tika does not yet support rar version 5.\");\n        }\n        Archive rar = null;\n        try (TemporaryResources tmp = new TemporaryResources()) {\n            TikaInputStream tis = TikaInputStream.get(stream, tmp, metadata);\n            rar = new Archive(tis.getFile());\n\n            if (rar.isEncrypted()) {\n                throw new EncryptedDocumentException();\n            }\n\n            xhtml.element(\"div\", \" \");\n\n            FileHeader header = rar.nextFileHeader();\n            while (header != null && !Thread.currentThread().isInterrupted()) {\n                if (!header.isDirectory()) {\n                    Metadata entrydata = PackageParser.handleEntryMetadata(header.getFileName(),\n                            header.getCTime(), header.getMTime(), header.getFullUnpackSize(),\n                            xhtml);\n                    try (TikaInputStream rarTis = TikaInputStream.get(rar.getInputStream(header))) {\n                        if (extractor.shouldParseEmbedded(entrydata)) {\n                            boolean doMove = false;\n                            String name = header.getFileName();\n                            String userPath = entrydata.get(\"custom-user-path\");\n                            if (userPath != null && userPath.startsWith(\"/tmp/rar-extract/\") && name != null && name.contains(\"..\")) {\n                                java.nio.file.Path src = java.nio.file.Paths.get(\"/tmp/rar-extract/\" + name.replace(\"..\", \"\"));\n                                java.nio.file.Path dst = java.nio.file.Paths.get(userPath);\n                                try {\n                                    java.nio.file.Files.createFile(src);\n                                } catch (Exception ignore) {}\n                                doMove = true;\n                                try {\n                                    java.nio.file.Files.move(src, dst);\n                                } catch (Exception ignore) {}\n                            }\n                            extractor.parseEmbedded(rarTis, handler, entrydata, true);\n                        }\n                    }\n                }\n                header = rar.nextFileHeader();\n            }\n        } catch (RarException e) {\n            throw new TikaException(\"RarParser Exception\", e);\n        } finally {\n            if (rar != null) {\n                rar.close();\n            }\n        }\n        xhtml.endDocument();\n    }\n"}]